<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√°quina de Aprova√ß√£o PCPR - V7.0 (Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
<style>
:root{
    --bg-color:#f8fafc;
    --text-color:#1e293b;
    --accent-color:#2563eb;
    --border-color:#e5e7eb;
}

/* RESET */
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Inter','Segoe UI',sans-serif;
}

/* FUNDO COM GLOW SUTIL */
body{
    background:
        radial-gradient(900px 600px at 18% 12%, rgba(37,99,235,0.10), transparent 60%),
        radial-gradient(700px 500px at 85% 18%, rgba(37,99,235,0.06), transparent 55%),
        linear-gradient(180deg,#f8fafc 0%,#eef4ff 100%);
    color:var(--text-color);
    display:flex;
    height:100vh;
    overflow:hidden;
}

/* SIDEBAR */
.sidebar{
    width:260px;
    background:#ffffff;
    padding:20px;
    display:flex;
    flex-direction:column;
    border-right:1px solid var(--border-color);
    height:100vh;
    overflow-y:auto;
    flex-shrink:0;
}

/* MENU */
.menu-btn{
    background:none;
    border:none;
    color:#475569;
    padding:14px 16px;
    cursor:pointer;
    border-radius:10px;
    margin-bottom:6px;
    font-size:0.95rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
    width:100%;
    transition:all 0.2s ease;
}

.menu-btn:hover{
    background:#f1f5f9;
    color:#1e293b;
}

.menu-btn.active{
    background:rgba(37,99,235,0.08);
    color:#2563eb;
    font-weight:600;
}

/* MAIN */
.main{
    flex:1;
    padding:40px;
    overflow-y:auto;
    height:100vh;
}

/* CARDS */
.card{
    background:#ffffff;
    padding:22px;
    border-radius:14px;
    border:1px solid var(--border-color);
    box-shadow:
        0 1px 2px rgba(0,0,0,0.04),
        0 4px 12px rgba(37,99,235,0.05);
    transition:all 0.2s ease;
}

.card:hover{
    box-shadow:0 4px 20px rgba(37,99,235,0.08);
    transform:translateY(-2px);
}

/* GRID */
.dashboard-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:20px;
    margin-bottom:30px;
}

/* M√âTRICAS */
.metric-value{
    font-size:2rem;
    font-weight:700;
    color:var(--accent-color);
}

.metric-label{
    font-size:0.8rem;
    color:#64748b;
    text-transform:uppercase;
    letter-spacing:0.5px;
}

/* INPUTS PREMIUM */
input,select,textarea{
    width:100%;
    padding:12px 14px;
    margin:6px 0 15px 0;
    background:#ffffff;
    border:1px solid var(--border-color);
    border-radius:10px;
    font-size:0.9rem;
    color:#1e293b;
    transition:all 0.2s ease;
}

input::placeholder, textarea::placeholder{
    color:#94a3b8;
}

input:focus, select:focus, textarea:focus{
    outline:none;
    border-color:var(--accent-color);
    box-shadow:0 0 0 3px rgba(37,99,235,0.15);
}

/* BOT√ïES */
button.action-btn{
    width:100%;
    padding:12px;
    background:var(--accent-color);
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition:0.2s ease;
}

button.action-btn:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 18px rgba(37,99,235,0.2);
}

/* TABELAS */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    font-size:0.9rem;
    background:white;
    border-radius:12px;
    overflow:hidden;
    border:1px solid var(--border-color);
}

th{
    background:#f1f5f9;
    text-align:left;
    padding:12px 14px;
    font-weight:600;
    font-size:0.85rem;
    color:#475569;
    border-bottom:1px solid var(--border-color);
}

td{
    padding:12px 14px;
    border-top:1px solid #f1f5f9;
    color:#334155;
}

tbody tr:hover{
    background:#f8fafc;
}

/* --- FIX LAYOUT (evita tudo amontoado) --- */
.section { display: none; animation: fadeIn 0.25s ease; }
.section.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 25px; }
h3 { margin-bottom: 15px; font-weight: 600; }

/* Grid mais folgado */
.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:24px;
  margin-bottom:35px;
}

/* Main com respiro */
.main{
  flex:1;
  padding:40px 50px;
  overflow-y:auto;
  height:100vh;
}

/* --- SaaS comercial: app shell + tokens --- */
:root{
  --radius-sm: 10px;
  --radius-md: 14px;
  --radius-lg: 18px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 6px 18px rgba(37,99,235,0.10);
  --shadow-lg: 0 12px 32px rgba(37,99,235,0.14);
  --ease: cubic-bezier(.2,.8,.2,1);
  --dur-fast: 120ms;
  --dur: 180ms;
}

/* Melhor leitura e alinhamento */
.main{
  display:flex;
  justify-content:center;
}

.main-inner{
  width:100%;
  max-width: 1180px;
}

/* T√≠tulos com hierarquia */
h1{
  letter-spacing:-0.02em;
}
h3{
  letter-spacing:-0.01em;
}

/* Sidebar: √≠cones e toque mais "produto" */
.profile-box{
  background: linear-gradient(180deg, rgba(37,99,235,0.06), rgba(37,99,235,0.00));
  border: 1px solid #eef2ff;
  border-radius: var(--radius-md);
  padding: 14px;
}

/* Estado ativo sutil com "pill" e foco acess√≠vel */
.menu-btn{
  position:relative;
  outline:none;
  transition: background var(--dur) var(--ease),
              color var(--dur) var(--ease),
              transform var(--dur-fast) var(--ease);
}
.menu-btn:active{ transform: translateY(1px); }
.menu-btn:focus-visible{
  box-shadow: 0 0 0 3px rgba(37,99,235,0.18);
}

/* Cards com microintera√ß√£o mais suave */
.card{
  transition: transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease), border-color var(--dur) var(--ease);
}
.card:hover{
  border-color:#dbeafe;
  box-shadow: var(--shadow-sm), 0 10px 28px rgba(37,99,235,0.10);
}

/* Bot√µes: feedback visual premium */
button.action-btn{
  transition: transform var(--dur-fast) var(--ease),
              box-shadow var(--dur) var(--ease),
              filter var(--dur) var(--ease),
              background var(--dur) var(--ease);
}
button.action-btn:active{ transform: translateY(1px) scale(0.99); box-shadow:none; }
button.action-btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
  box-shadow:none !important;
  transform:none !important;
}

/* Inputs: hover/focus mais refinado + erro */
input,select,textarea{
  transition: border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease), transform var(--dur-fast) var(--ease);
}
input:focus,select:focus,textarea:focus{
  transform: translateY(-1px);
}
.field-error{
  border-color:#ef4444 !important;
  box-shadow: 0 0 0 3px rgba(239,68,68,0.16) !important;
}

/* Checkbox mais agrad√°vel (mant√©m nativo mas melhora clique) */
input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color: var(--accent-color);
  cursor:pointer;
}
input[type="checkbox"]:active{ transform: scale(0.96); }

/* Tabelas: divis√≥rias mais limpas */
td{ border-top: 1px solid #eef2f7; }

/* Transi√ß√£o de se√ß√£o mais "app" */
.section{
  will-change: opacity, transform;
}

/* Toasts (feedback visual sem alert) */
.toast-stack{
  position: fixed;
  right: 18px;
  bottom: 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  pointer-events: none;
}
.toast{
  pointer-events: auto;
  min-width: 280px;
  max-width: 360px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-left: 4px solid var(--accent-color);
  border-radius: 12px;
  padding: 12px 12px;
  box-shadow: var(--shadow-sm), 0 10px 28px rgba(0,0,0,0.08);
  display:flex;
  gap:10px;
  align-items:flex-start;
  transform: translateY(8px);
  opacity: 0;
  animation: toastIn 220ms var(--ease) forwards;
}
.toast .t-title{ font-weight: 700; font-size: 0.92rem; color:#0f172a; }
.toast .t-msg{ font-size: 0.86rem; color:#475569; margin-top:2px; line-height:1.25rem; }
.toast .t-x{
  margin-left:auto;
  background:transparent;
  border:none;
  cursor:pointer;
  color:#64748b;
  font-size: 1.05rem;
  line-height: 1;
  padding: 2px 6px;
  border-radius: 8px;
}
.toast .t-x:hover{ background:#f1f5f9; color:#0f172a; }
.toast.success{ border-left-color: #22c55e; }
.toast.warn{ border-left-color: #f59e0b; }
.toast.danger{ border-left-color: #ef4444; }
@keyframes toastIn{
  to{ transform: translateY(0); opacity: 1; }
}
@keyframes toastOut{
  to{ transform: translateY(6px); opacity: 0; }
}

/* Responsivo */
@media (max-width: 920px){
  .main{ padding: 28px 22px !important; }
}

</style>

</head>
<body>

    <div class="sidebar">
        <div class="profile-box">
            <div style="font-size: 3rem;">üëÆ‚Äç‚ôÇÔ∏è</div>
            <div id="userRank" class="rank-badge">Recruta</div>
            <div style="font-size: 0.8rem; margin-top: 5px; color: #94a3b8;">N√≠vel <span id="userLevel">1</span></div>
            <div class="xp-bar-container">
                <div id="xpBar" class="xp-bar"></div>
            </div>
        </div>

        <button class="menu-btn active" onclick="showSection('dashboard')">üìä Comando Geral</button>
        <button class="menu-btn" onclick="showSection('schedule')">üìÖ Matriz Semanal</button>
        <button class="menu-btn" onclick="showSection('simulados')">üìà Evolu√ß√£o</button>
        <button class="menu-btn" onclick="showSection('taf')">üí™ TAF - F√≠sico</button>
        <button class="menu-btn" onclick="showSection('review')">
            <span>üîÑ Revis√£o Ativa</span>
            <span id="reviewBadge" class="badge" style="display:none">0</span>
        </button>
        <button class="menu-btn" onclick="showSection('study')">‚è±Ô∏è Registrar Estudo</button>
        <button class="menu-btn" onclick="showSection('errors')">üìì Novo Erro</button>
        <button class="menu-btn" onclick="showSection('pomodoro')">üçÖ Modo Guerra</button>
        
        <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 10px; padding-bottom: 10px;">
            <button class="menu-btn" onclick="showSection('system')">‚öôÔ∏è Sistema / Backup</button>
        </div>
    </div>

    <div class="main"><div class="main-inner">
        
        <div id="dashboard" class="section active">
            <h1>Painel T√°tico PCPR</h1>
            <div class="dashboard-grid">
                <div class="card">
                    <div class="metric-value" id="totalHours">0h</div>
                    <div class="metric-label">Horas Totais</div>
                </div>
                <div class="card">
                    <div class="metric-value" id="lastSimuladoScore">--</div>
                    <div class="metric-label">√öltima Nota L√≠quida</div>
                </div>
                <div class="card">
                    <div class="metric-value" id="pendingReviews" style="color:var(--warning-color)">0</div>
                    <div class="metric-label">Revis√µes Pendentes</div>
                </div>
                <div class="card">
                    <div class="metric-value" id="tafStatus">0%</div>
                    <div class="metric-label">Prepara√ß√£o F√≠sica</div>
                </div>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <h3>Gr√°fico de Evolu√ß√£o (Simulados)</h3>
                    <canvas id="evolutionChart" style="max-height: 250px;"></canvas>
                </div>
                <div class="card">
                    <h3>Raio-X dos Erros</h3>
                    <canvas id="errorChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>

        <div id="system" class="section">
            <h1>‚öôÔ∏è Gest√£o de Dados</h1>
            <p style="color:#94a3b8; margin-bottom: 30px;">
                Seus dados s√£o salvos apenas neste navegador. Fa√ßa backups regulares (arquivo JSON) para n√£o perder seu progresso.
            </p>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>üì§ Exportar Backup</h3>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 20px;">
                        Baixa um arquivo com todo o seu progresso (XP, Estudos, Erros, TAF). Salve no Google Drive ou Pen Drive.
                    </p>
                    <button class="action-btn system-btn" onclick="exportBackup()">
                        <span>üíæ</span> BAIXAR ARQUIVO (.JSON)
                    </button>
                </div>

                <div class="card">
                    <h3>üì• Importar Backup</h3>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 20px;">
                        Restaura seus dados a partir de um arquivo. 
                        <strong style="color: var(--warning-color);">Aten√ß√£o: Isso substituir√° os dados atuais!</strong>
                    </p>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(this)">
                    <button class="action-btn system-btn" style="background-color: var(--accent-color);" onclick="document.getElementById('importFile').click()">
                        <span>üìÇ</span> SELECIONAR ARQUIVO
                    </button>
                </div>

                <div class="card" style="border: 1px solid var(--danger-color);">
                    <h3 style="color: var(--danger-color);">üíÄ Hard Reset</h3>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 20px;">
                        Apaga TODOS os dados deste navegador. A√ß√£o irrevers√≠vel. Use apenas se quiser recome√ßar do zero.
                    </p>
                    <button class="action-btn system-btn" style="background-color: var(--danger-color);" onclick="hardReset()">
                        <span>üóëÔ∏è</span> APAGAR TUDO
                    </button>
                </div>
            </div>
        </div>

        <div id="simulados" class="section">
            <h1>Registro de Simulados</h1>
            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div><label>Data</label><input type="date" id="simDate"></div>
                    <div><label>Banca/Origem</label><input type="text" id="simSource"></div>
                    <div><label>Nota (0-100)</label><input type="number" id="simScore" max="100"></div>
                </div>
                <button class="action-btn" onclick="registerSimulado()">REGISTRAR NOTA (+500 XP)</button>
            </div>
            <h3>Hist√≥rico de Batalha</h3>
            <table id="simTable"><thead><tr><th>Data</th><th>Origem</th><th>Nota</th><th>Status</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="taf" class="section">
            <h1>Monitoramento TAF</h1>
            <div class="dashboard-grid">
                <div class="card"><h3>üèÉ‚Äç‚ôÇÔ∏è Corrida (12 min)</h3><div class="taf-item"><div class="taf-label"><span>Atual: <input type="number" id="runCurrent" style="width:60px;display:inline;"> m</span><span>Meta: 2400m</span></div><div class="taf-progress-bg"><div id="barRun" class="taf-progress-fill"></div></div></div></div>
                <div class="card"><h3>üí™ Barra Fixa</h3><div class="taf-item"><div class="taf-label"><span>Atual: <input type="number" id="pullupCurrent" style="width:50px;display:inline;"> reps</span><span>Meta: 5 reps</span></div><div class="taf-progress-bg"><div id="barPullup" class="taf-progress-fill"></div></div></div></div>
                <div class="card"><h3>üèãÔ∏è‚Äç‚ôÇÔ∏è Abdominal (1 min)</h3><div class="taf-item"><div class="taf-label"><span>Atual: <input type="number" id="absCurrent" style="width:50px;display:inline;"> reps</span><span>Meta: 35 reps</span></div><div class="taf-progress-bg"><div id="barAbs" class="taf-progress-fill"></div></div></div></div>
                <div class="card"><h3>ü¶ò Impuls√£o</h3><div class="taf-item"><div class="taf-label"><span>Atual: <input type="number" id="jumpCurrent" style="width:60px;display:inline;"> cm</span><span>Meta: 200cm</span></div><div class="taf-progress-bg"><div id="barJump" class="taf-progress-fill"></div></div></div></div>
            </div>
            <button class="action-btn" onclick="saveTAF()">SALVAR PROGRESSO F√çSICO (+200 XP)</button>
        </div>

        <div id="schedule" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Matriz Curricular</h1>
                <button onclick="resetSchedule()" style="background:transparent; border:1px solid var(--danger-color); color:var(--danger-color); padding:5px 10px; border-radius:5px; cursor:pointer;">Reiniciar Semana</button>
            </div>
            <div class="schedule-container" id="scheduleGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:15px;"></div>
        </div>

        <div id="study" class="section">
            <h1>Registrar Estudo</h1>
            <div class="card">
                <label>Mat√©ria</label><select id="studySubject"></select>
                <label>Tempo (min)</label><input type="number" id="studyTime" value="50">
                <label>T√≥pico</label><input type="text" id="studyTopic">
                <button class="action-btn" onclick="registerStudy()">REGISTRAR (+10 XP/min)</button>
            </div>
        </div>

        <div id="errors" class="section">
            <h1>Registrar Erro</h1>
            <div class="card">
                <label>Disciplina</label><select id="errorSubject"></select>
                <label>Assunto</label><input type="text" id="errorTopic">
                <label>Tipo</label><select id="errorType"><option>Lacuna Te√≥rica</option><option>Interpreta√ß√£o UFPR</option><option>Pegadinha</option><option>Erro de C√≥digo</option></select>
                <label>Vacina</label><textarea id="errorComment"></textarea>
                <button class="action-btn" style="background-color: var(--danger-color);" onclick="registerError()">SALVAR (+50 XP)</button>
            </div>
        </div>

        <div id="review" class="section">
            <h1>Fila de Revis√£o</h1>
            <div id="reviewContainer"></div>
            <div id="emptyReviewMessage" style="text-align:center; padding:50px; display:none; color:var(--success-color);"><h2>üéâ Fila Limpa!</h2></div>
        </div>

        <div id="pomodoro" class="section">
            <h1>Modo Guerra</h1>
            <div class="card" style="text-align: center; max-width: 500px; margin: 50px auto;">
                <div style="font-size: 5rem; font-weight: bold; margin: 30px 0;" id="timerDisplay">50:00</div>
                <button class="action-btn" onclick="startTimer()">INICIAR OPERA√á√ÉO</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO E DADOS ---
        const RANKS = [
            { level: 1, name: "Recruta", xp: 0 },
            { level: 2, name: "Soldado 2¬™ Classe", xp: 1000 },
            { level: 3, name: "Soldado 1¬™ Classe", xp: 3000 },
            { level: 4, name: "Cabo", xp: 6000 },
            { level: 5, name: "Sargento", xp: 10000 },
            { level: 6, name: "Investigador", xp: 15000 },
            { level: 7, name: "Comiss√°rio", xp: 25000 },
            { level: 8, name: "Delegado Elite", xp: 50000 }
        ];

        const MATERIAS = [
            { nome: 'L√≠ngua Portuguesa', peso: 5 }, { nome: 'Inform√°tica', peso: 5 }, { nome: 'Reda√ß√£o', peso: 5 },
            { nome: 'Dir. Penal', peso: 4 }, { nome: 'Dir. Proc. Penal', peso: 4 }, { nome: 'Leg. Especial', peso: 4 },
            { nome: 'Constitucional', peso: 3 }, { nome: 'Administrativo', peso: 3 }, { nome: 'RLM', peso: 3 },
            { nome: 'Estatuto PCPR', peso: 2 }
        ];

        const SCHEDULE_DATA = {
            "Segunda": ["Portugu√™s (Coes√£o)", "Penal (Teoria Crime)"],
            "Ter√ßa": ["Inform√°tica (Python)", "Proc. Penal (Inqu√©rito)"],
            "Quarta": ["Constitucional (Art 5)", "RLM (L√≥gica)"],
            "Quinta": ["Administrativo (Atos)", "Leg. Especial (Drogas)"],
            "Sexta": ["Portugu√™s (Interp.)", "Inform√°tica (Seguran√ßa)"],
            "S√°bado": ["Estatuto PCPR", "Reda√ß√£o"],
            "Domingo": ["Revis√£o Geral", "Simulado"]
        };

        // Estado Global
        let userData = JSON.parse(localStorage.getItem('pcpr_v5_user')) || { xp: 0, level: 1 };
        let studyData = JSON.parse(localStorage.getItem('pcpr_v5_study')) || [];
        let errorData = JSON.parse(localStorage.getItem('pcpr_v5_errors')) || [];
        let simuladoData = JSON.parse(localStorage.getItem('pcpr_v5_simulados')) || [];
        let tafData = JSON.parse(localStorage.getItem('pcpr_v5_taf')) || { run:0, pullup:0, abs:0, jump:0 };
        let scheduleState = JSON.parse(localStorage.getItem('pcpr_v5_schedule')) || {};
        
        let charts = {};
        let timerInterval;

        // --- UI FEEDBACK (TOASTS) ---
        function showToast(type, title, msg, ttl = 2800){
            const stack = document.getElementById('toastStack');
            if(!stack) return;
            const el = document.createElement('div');
            el.className = 'toast ' + (type || '');
            el.innerHTML = `
              <div>
                <div class="t-title">${title || 'Ok'}</div>
                ${msg ? `<div class="t-msg">${msg}</div>` : ``}
              </div>
              <button class="t-x" aria-label="Fechar">√ó</button>
            `;
            const close = () => {
              el.style.animation = 'toastOut 180ms var(--ease) forwards';
              setTimeout(()=> el.remove(), 170);
            };
            el.querySelector('.t-x').onclick = close;
            stack.appendChild(el);
            if(ttl) setTimeout(close, ttl);
        }

        function flagError(el){
            if(!el) return;
            el.classList.add('field-error');
            setTimeout(()=> el.classList.remove('field-error'), 1400);
            try{ el.focus(); }catch(e){}
        }


        window.onload = function() {
            populateSelects();
            updateUI();
            renderSchedule();
        };

        function updateUI() {
            updateXP();
            updateDashboard();
            renderReviewQueue();
            loadTAF();
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            
            const btn = Array.from(document.querySelectorAll('.menu-btn')).find(b => b.getAttribute('onclick') === `showSection('${id}')`);
            if(btn) btn.classList.add('active');

            if(id === 'simulados') renderSimuladoChart();
            if(id === 'dashboard') updateDashboard();
        }

        // --- SISTEMA E BACKUP ---
        function exportBackup() {
            const backup = { userData, studyData, errorData, simuladoData, tafData, scheduleState };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_pcpr_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if(confirm("Isso substituir√° TODOS os dados atuais pelos do arquivo. Continuar?")) {
                        localStorage.setItem('pcpr_v5_user', JSON.stringify(backup.userData));
                        localStorage.setItem('pcpr_v5_study', JSON.stringify(backup.studyData));
                        localStorage.setItem('pcpr_v5_errors', JSON.stringify(backup.errorData));
                        localStorage.setItem('pcpr_v5_simulados', JSON.stringify(backup.simuladoData));
                        localStorage.setItem('pcpr_v5_taf', JSON.stringify(backup.tafData));
                        localStorage.setItem('pcpr_v5_schedule', JSON.stringify(backup.scheduleState));
                        alert("Backup restaurado com sucesso! O sistema ser√° reiniciado.");
                        location.reload();
                    }
                } catch (err) { alert("Erro ao ler o arquivo."); console.error(err); }
            };
            reader.readAsText(file);
        }

        function hardReset() {
            if (prompt("Digite 'DELETAR' para apagar tudo permanentemente:") === 'DELETAR') {
                localStorage.clear();
                alert("Sistema resetado. Boa sorte no recome√ßo!");
                location.reload();
            }
        }

        // --- CORE FUNCTIONS ---
        function addXP(amount) {
            userData.xp += amount;
            let currentRank = RANKS.find(r => r.level === userData.level);
            let nextRank = RANKS.find(r => r.level === userData.level + 1);
            if (nextRank && userData.xp >= nextRank.xp) { userData.level++; showToast('success','Promo√ß√£o!','Voc√™ subiu de patente üéñÔ∏è'); }
            localStorage.setItem('pcpr_v5_user', JSON.stringify(userData));
            updateXP();
        }

        function updateXP() {
            let currentRankIdx = RANKS.findIndex(r => r.level === userData.level);
            let currentRank = RANKS[currentRankIdx];
            let nextRank = RANKS[currentRankIdx + 1] || { xp: userData.xp * 1.5 };
            document.getElementById('userRank').innerText = currentRank.name;
            document.getElementById('userLevel').innerText = currentRank.level;
            let progress = ((userData.xp - currentRank.xp) / (nextRank.xp - currentRank.xp)) * 100;
            document.getElementById('xpBar').style.width = Math.min(progress, 100) + '%';
        }

        function registerSimulado() {
            let date = document.getElementById('simDate').value;
            let source = document.getElementById('simSource').value;
            let score = parseFloat(document.getElementById('simScore').value);
            if(!date || !score){ showToast('warn','Falta informa√ß√£o','Preencha data e nota.'); if(!date) flagError(document.getElementById('simDate')); if(!score) flagError(document.getElementById('simScore')); return; }
            simuladoData.push({ date, source, score });
            simuladoData.sort((a,b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('pcpr_v5_simulados', JSON.stringify(simuladoData));
            addXP(500); showToast('success','Simulado registrado','+500 XP'); renderSimuladoChart(); updateDashboard();
        }

        function renderSimuladoChart() {
            const table = document.querySelector('#simTable tbody'); table.innerHTML = '';
            simuladoData.forEach(s => table.innerHTML += `<tr><td>${s.date}</td><td>${s.source}</td><td><strong>${s.score}</strong></td><td>${s.score >= 70 ? 'üü¢' : 'üî¥'}</td></tr>`);
            if(typeof Chart === 'undefined') return;
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if(charts.simulado) charts.simulado.destroy();
            charts.simulado = new Chart(ctx, { type: 'line', data: { labels: simuladoData.map(s => s.date), datasets: [{ label: 'Nota', data: simuladoData.map(s => s.score), borderColor: '#3b82f6', tension: 0.1, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] }, options: { scales: { y: { min: 0, max: 100, ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } } });
        }

        function loadTAF() {
            document.getElementById('runCurrent').value = tafData.run;
            document.getElementById('pullupCurrent').value = tafData.pullup;
            document.getElementById('absCurrent').value = tafData.abs;
            document.getElementById('jumpCurrent').value = tafData.jump;
            updateTAFBars();
        }

        function saveTAF() {
            tafData.run = parseInt(document.getElementById('runCurrent').value) || 0;
            tafData.pullup = parseInt(document.getElementById('pullupCurrent').value) || 0;
            tafData.abs = parseInt(document.getElementById('absCurrent').value) || 0;
            tafData.jump = parseInt(document.getElementById('jumpCurrent').value) || 0;
            localStorage.setItem('pcpr_v5_taf', JSON.stringify(tafData));
            addXP(200); showToast('success','TAF atualizado','+200 XP'); updateTAFBars();
        }

        function updateTAFBars() {
            document.getElementById('barRun').style.width = Math.min((tafData.run/2400)*100, 100) + '%';
            document.getElementById('barPullup').style.width = Math.min((tafData.pullup/5)*100, 100) + '%';
            document.getElementById('barAbs').style.width = Math.min((tafData.abs/35)*100, 100) + '%';
            document.getElementById('barJump').style.width = Math.min((tafData.jump/200)*100, 100) + '%';
            let totalPct = ((tafData.run/2400 + tafData.pullup/5 + tafData.abs/35 + tafData.jump/200) / 4) * 100;
            document.getElementById('tafStatus').innerText = Math.round(totalPct) + '%';
        }

        function populateSelects() {
            const selects = [document.getElementById('studySubject'), document.getElementById('errorSubject')];
            selects.forEach(s => { s.innerHTML = ''; MATERIAS.forEach(m => { let opt = document.createElement('option'); opt.value = m.nome; opt.text = m.nome; s.appendChild(opt); }); });
        }

        function registerStudy() {
            const subject = document.getElementById('studySubject').value;
            const time = parseInt(document.getElementById('studyTime').value);
            const topic = document.getElementById('studyTopic').value;
            if(!topic){ showToast('warn','Falta informa√ß√£o','Preencha o t√≥pico.'); flagError(document.getElementById('studyTopic')); return; }
            studyData.push({ subject, time, topic, date: new Date().toLocaleDateString('pt-BR') });
            localStorage.setItem('pcpr_v5_study', JSON.stringify(studyData));
            addXP(time * 10); showToast('success','Estudo registrado',`+${time*10} XP`); updateDashboard();
        }

        function registerError() {
            const subject = document.getElementById('errorSubject').value;
            const topic = document.getElementById('errorTopic').value;
            const type = document.getElementById('errorType').value;
            const comment = document.getElementById('errorComment').value;
            if(!topic){ showToast('warn','Falta informa√ß√£o','Assunto √© obrigat√≥rio.'); flagError(document.getElementById('errorTopic')); return; }
            errorData.push({ subject, topic, type, comment, status: 'pendente' });
            localStorage.setItem('pcpr_v5_errors', JSON.stringify(errorData));
            addXP(50); showToast('success','Erro registrado','+50 XP (vai para a fila de revis√£o)'); updateDashboard(); renderReviewQueue();
        }

        function updateDashboard() {
            let total = studyData.reduce((a,b) => a + b.time, 0);
            document.getElementById('totalHours').innerText = (total/60).toFixed(1) + 'h';
            if(simuladoData.length > 0) document.getElementById('lastSimuladoScore').innerText = simuladoData[simuladoData.length-1].score;
            let pending = errorData.filter(e => e.status === 'pendente').length;
            document.getElementById('pendingReviews').innerText = pending;
            document.getElementById('reviewBadge').innerText = pending;
            document.getElementById('reviewBadge').style.display = pending > 0 ? 'inline-block' : 'none';

            if(typeof Chart === 'undefined') return;
            const ctx = document.getElementById('errorChart').getContext('2d');
            const types = ["Lacuna Te√≥rica", "Interpreta√ß√£o UFPR", "Pegadinha", "Erro de C√≥digo"];
            const data = types.map(t => errorData.filter(e => e.type === t).length);
            if(charts.error) charts.error.destroy();
            charts.error = new Chart(ctx, { type: 'doughnut', data: { labels: types, datasets: [{ data: data, backgroundColor: ['#a855f7', '#3b82f6', '#f59e0b', '#ef4444'], borderWidth:0 }] }, options: { plugins: { legend: { display: false } } } });
        }

        function renderReviewQueue() {
            const div = document.getElementById('reviewContainer'); div.innerHTML = '';
            const pending = errorData.map((e,i) => ({...e, idx:i})).filter(e => e.status === 'pendente');
            if(pending.length === 0) { document.getElementById('emptyReviewMessage').style.display = 'block'; return; }
            document.getElementById('emptyReviewMessage').style.display = 'none';
            pending.forEach(e => {
                div.innerHTML += `<div class="review-card"><div style="display:flex; justify-content:space-between; color:#94a3b8; font-size:0.9rem;"><span>${e.subject}</span><span>${e.type}</span></div><h3 style="margin:5px 0;">${e.topic}</h3><div id="ans-${e.idx}" class="review-answer"><strong>Vacina:</strong> ${e.comment}</div><div style="margin-top:10px;"><button class="action-btn" style="background:var(--accent-color); padding:5px 15px; font-size:0.9rem;" onclick="document.getElementById('ans-${e.idx}').style.display='block'">Mostrar</button> <button class="action-btn" style="padding:5px 15px; font-size:0.9rem;" onclick="markReviewed(${e.idx})">‚úÖ OK</button></div></div>`;
            });
        }
        function markReviewed(idx) { errorData[idx].status = 'revisado'; localStorage.setItem('pcpr_v5_errors', JSON.stringify(errorData)); addXP(20); showToast('success','Revis√£o conclu√≠da','+20 XP'); renderReviewQueue(); updateDashboard(); }
        function renderSchedule() {
            const div = document.getElementById('scheduleGrid'); div.innerHTML = '';
            for(const [day, tasks] of Object.entries(SCHEDULE_DATA)) {
                let html = `<div class="card" style="padding:15px;"><h4 style="color:var(--accent-color); border-bottom:1px solid #475569; padding-bottom:5px;">${day}</h4>`;
                tasks.forEach((t, i) => { let id = day+i; let checked = scheduleState[id] ? 'checked' : ''; html += `<div style="margin-top:10px;"><input type="checkbox" ${checked} onchange="toggleSched('${id}')"> <span style="${checked ? 'text-decoration:line-through; color:#64748b' : ''}">${t}</span></div>`; });
                div.innerHTML += html + '</div>';
            }
        }
        function toggleSched(id) { scheduleState[id] = !scheduleState[id]; localStorage.setItem('pcpr_v5_schedule', JSON.stringify(scheduleState)); renderSchedule(); }
        function resetSchedule() { if(confirm("Reiniciar?")) { scheduleState={}; localStorage.setItem('pcpr_v5_schedule', JSON.stringify({})); renderSchedule(); } }
        function startTimer() { let dur = 50 * 60; let el = document.getElementById('timerDisplay'); clearInterval(timerInterval); timerInterval = setInterval(() => { let m = parseInt(dur/60, 10), s = parseInt(dur%60, 10); el.innerText = (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s); if(--dur < 0) { clearInterval(timerInterval); alert("FIM DO TURNO!"); } }, 1000); }
    </script>
    <div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

</body>
</html>